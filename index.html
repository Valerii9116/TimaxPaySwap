<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; connect-src 'self' https://li.quest wss://*.bridge.walletconnect.org https://cdn.jsdelivr.net;">
    <title>TimaxPaySwap - Cross-Chain Swaps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- WalletConnect Client SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .header-gradient {
            background: linear-gradient(90deg, #4f46e5, #ec4899);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .action-button {
            background-color: #4f46e5; color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39); border: none; cursor: pointer;
        }
        .action-button:hover:not(:disabled) {
            background-color: #4338ca; transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(79, 70, 229, 0.5);
        }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-message { padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-weight: 500; }
        .status-loading { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .status-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
        .status-success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #4ade80; }
        .swap-arrow {
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center;
            justify-content: center; margin: -1.25rem auto; cursor: pointer; transition: all 0.2s ease; z-index: 10; position: relative;
        }
        .swap-arrow:hover { transform: rotate(180deg); background: rgba(79, 70, 229, 0.2); }
        .token-input-card { background: rgba(0,0,0, 0.2); padding: 1rem; border-radius: 1rem; }
        .token-input-container { display: flex; align-items: center; background: rgba(0,0,0, 0.25); border-radius: 0.75rem; }
        .token-input {
            background: transparent; border: none; padding: 0.75rem 1rem; color: white;
            flex-grow: 1; font-size: 1.25rem; width: 60%;
        }
        .token-input:focus { outline: none; }
        .token-selector {
            background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem; padding: 0.5rem 0.75rem; color: white; cursor: pointer;
            font-weight: 500;
        }
        select.token-selector { -webkit-appearance: none; appearance: none; }
        select.token-selector option {
            background: #1f2937; /* Dark background for dropdown options */
        }
        .max-button {
            background-color: #4f46e5; color: white; border: none; padding: 0 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: bold; cursor: pointer; margin-left: 8px;
        }
        .wallet-option {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.75rem; padding: 0.75rem 1rem; margin: 0.5rem 0;
            cursor: pointer; transition: all 0.2s ease;
        }
        .wallet-option:hover { background: rgba(255,255,255,0.15); }
        .wallet-option:active { transform: scale(0.98); }
        .config-banner {
            background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; text-center;
            font-size: 0.875rem; color: #4ade80;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            z-index: 50; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #1f2937; padding: 2rem; border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%; max-width: 400px; text-align: center;
        }
        #qr-code-container {
            margin: 1.5rem auto; background: white; padding: 1rem; border-radius: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Configuration Section - EDIT YOUR VALUES HERE -->
    <script>
        // üîß CONFIGURATION - Update these values with your settings
        window.TIMAX_CONFIG = {
            // Get your project ID from https://cloud.walletconnect.com
            WALLETCONNECT_PROJECT_ID: 'dc14d146c0227704322ac9a46aaed7cd', // ‚ö†Ô∏è CHANGE THIS

            // LI.FI API Settings
            LIFI_API_URL: 'https://li.quest/v1',
            LIFI_INTEGRATOR: 'Timax_swap', // ‚ö†Ô∏è CHANGE THIS to your registered integrator name

            // Supported Chains (Chain IDs) - Add/remove as needed
            LIFI_CHAINS: [
                1,      // Ethereum
                10,     // Optimism
                130,    // Unichain
                59144,  // Linea 
                43114,  // Avalanche 
                137,    // Polygon
                42161,  // Arbitrum
                56,     // BSC
                8453    // Base
            ],

            // Supported Tokens - Add/remove as needed  
            LIFI_TOKENS: [
                'ETH', 'WETH', 'USDC', 'USDT', 'DAI', 
                'MATIC', 'BNB', 'WBTC', 'UNI', 'LINK'
            ],

            // Your fee collector wallet address
            VITE_FEE_COLLECTOR_ADDRESS: '0x34accc793fD8C2A8e262C8C95b18D706bc6022f0' // ‚ö†Ô∏è CHANGE THIS
        };

        // Debug info
        console.log('üìù TimaxPaySwap Configuration Loaded:', window.TIMAX_CONFIG);
    </script>

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">

        <header class="w-full max-w-lg mb-8 text-center">
            <h1 class="text-5xl md:text-6xl font-bold header-gradient mb-2">TimaxPaySwap</h1>
            <p class="text-gray-300 text-lg">Your gateway to seamless cross-chain swaps.</p>
        </header>

        <main id="main-content" class="w-full max-w-lg glass-container p-6 md:p-8">
            <!-- Configuration Notice -->
            <div class="config-banner">
                ‚úÖ Configuration loaded successfully from script
            </div>

            <div id="auth-screen" class="text-center">
                <p class="mb-6 text-gray-200">Connect your wallet to begin swapping assets across any chain, powered by LI.FI.</p>

                <!-- Mobile-friendly wallet connection options -->
                <div id="wallet-options">
                    <div id="metamask-option" class="wallet-option">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5C22.5 18.02 18.02 22.5 12.5 22.5C6.98 22.5 2.5 18.02 2.5 12.5C2.5 6.98 6.98 2.5 12.5 2.5C18.02 2.5 22.5 6.98 22.5 12.5Z" fill="#E2761B"></path><path d="M22.5 12.5C22.5 18.02 18.02 22.5 12.5 22.5C6.98 22.5 2.5 18.02 2.5 12.5C2.5 6.98 6.98 2.5 12.5 2.5C18.02 2.5 22.5 6.98 22.5 12.5Z" fill="url(#paint0_linear_14_4)"></path><path d="M12.5 2.5C18.02 2.5 22.5 6.98 22.5 12.5C22.5 18.02 18.02 22.5 12.5 22.5C6.98 22.5 2.5 18.02 2.5 12.5C2.5 6.98 6.98 2.5 12.5 2.5" fill="#E2761B"></path><path d="M16.29 6.84L14.6 9.42L12.5 7.9L10.4 9.42L8.71 6.84L6.5 10.33V15.79L8.71 17.17L10.4 15.34L12.5 16.71L14.6 15.34L16.29 17.17L18.5 15.79V10.33L16.29 6.84Z" fill="white"></path><defs><linearGradient id="paint0_linear_14_4" x1="12.5" y1="2.5" x2="12.5" y2="22.5" gradientUnits="userSpaceOnUse"><stop stop-color="#E2761B"></stop><stop offset="1" stop-color="#D95C2B"></stop></linearGradient></defs></svg>
                        <span>MetaMask</span>
                    </div>

                    <div id="walletconnect-option" class="wallet-option">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 9.5C8.5 6.5 13.5 6.5 16.5 9.5L17.5 10.5C17.8 10.8 17.8 11.2 17.5 11.5L16.5 12.5C16.2 12.8 15.8 12.8 15.5 12.5L14.8 11.8C12.8 9.8 9.2 9.8 7.2 11.8L6.5 12.5C6.2 12.8 5.8 12.8 5.5 12.5L4.5 11.5C4.2 11.2 4.2 10.8 4.5 10.5L5.5 9.5Z" fill="#3B99FC"></path></svg>
                        <span>WalletConnect</span>
                    </div>

                    <div id="trust-wallet-option" class="wallet-option">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L3 7V12C3 17.55 6.84 22.74 12 24C17.16 22.74 21 17.55 21 12V7L12 2Z" fill="#3375BB"></path><path d="M12 22C16.42 20.92 19 16.76 19 12.5V8.5L12 5.5L5 8.5V12.5C5 16.76 7.58 20.92 12 22Z" fill="white"></path></svg>
                        <span>Trust Wallet</span>
                    </div>
                </div>
            </div>

            <div id="widget-screen" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <p id="wallet-address" class="text-sm text-gray-400 bg-gray-800/50 px-3 py-1 rounded-full truncate"></p>
                    <button id="disconnect-wallet-btn" class="text-sm text-red-400 hover:text-red-300 transition-colors">Disconnect</button>
                </div>

                <div id="status-container"></div>

                <div class="token-input-card">
                    <div class="flex justify-between items-center mb-2 text-sm text-gray-400">
                        <span>From</span>
                        <div class="flex items-center">
                            <span id="from-balance">Balance: 0.0</span>
                            <button id="max-btn" class="max-button ml-2">MAX</button>
                        </div>
                    </div>
                    <div class="token-input-container">
                        <input type="number" placeholder="0.0" class="token-input" id="from-amount" />
                        <select id="from-token" class="token-selector mr-2"></select>
                    </div>
                    <select id="from-chain" class="w-full mt-2 token-selector bg-transparent border-none p-0"></select>
                </div>

                <div class="swap-arrow" id="swap-direction">
                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 12l-4-4m4 4l4-4m6 8v12m0-12l-4 4m4-4l4 4"></path></svg>
                </div>

                <div class="token-input-card">
                    <div class="flex justify-between items-center mb-2 text-sm text-gray-400"><span>To (estimated)</span></div>
                    <div class="token-input-container">
                        <input type="number" placeholder="0.0" class="token-input" id="to-amount" readonly/>
                        <select id="to-token" class="token-selector mr-2"></select>
                    </div>
                    <select id="to-chain" class="w-full mt-2 token-selector bg-transparent border-none p-0"></select>
                </div>

                <button id="swap-btn" class="action-button w-full mt-6 mb-4" disabled>Enter Amount</button>

                <div id="route-info" class="hidden text-sm text-gray-400 space-y-2">
                    <div class="flex justify-between"><span>Rate:</span><span id="exchange-rate"></span></div>
                    <div class="flex justify-between"><span>Gas Fee:</span><span id="gas-fee"></span></div>
                    <div class="flex justify-between"><span>Total Fee (USD):</span><span id="total-fee"></span></div>
                </div>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>&copy; 2024 TimaxPaySwap. Powered by <a href="https://li.fi/" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300">LI.FI</a></p>
        </footer>
    </div>
    
    <!-- WalletConnect Modal -->
    <div id="walletconnect-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-2">Connect Wallet</h2>
            <p class="text-gray-400 mb-4">Scan QR code with your mobile wallet or use the mobile link.</p>
            <div id="qr-code-container"></div>
            <a id="mobile-connect-link" href="#" class="action-button w-full text-center block md:hidden">Connect on Mobile</a>
            <button id="close-modal-btn" class="mt-4 text-gray-400 hover:text-white">Cancel</button>
        </div>
    </div>


    <script>
        // --- SCRIPT START --- //

        // Global variables
        let currentUser, currentProvider, currentSigner, currentQuote, wcProvider;
        let allChains = [], allTokens = {}, currentBalance = '0';
        let CONFIG = window.TIMAX_CONFIG;

        // --- UI & UTILITY FUNCTIONS --- //

        const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (window.innerWidth <= 768);

        const showStatus = (message, type = 'loading') => {
            document.getElementById('status-container').innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        };

        const hideStatus = () => {
            document.getElementById('status-container').innerHTML = '';
        };

        const showScreen = (id) => {
            ['auth-screen', 'widget-screen'].forEach(sId => document.getElementById(sId).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        const showWCModal = () => document.getElementById('walletconnect-modal').classList.remove('hidden');
        const hideWCModal = () => document.getElementById('walletconnect-modal').classList.add('hidden');

        // --- WALLET MANAGEMENT --- //

        const onWalletConnected = async (provider) => {
            try {
                currentProvider = new ethers.providers.Web3Provider(provider);
                currentSigner = currentProvider.getSigner();
                const address = await currentSigner.getAddress();
                
                currentUser = { wallet: { address } };
                document.getElementById('wallet-address').textContent = `${address.slice(0, 6)}...${address.slice(-4)}`;

                showScreen('widget-screen');
                hideWCModal();
                await populateDropdowns();
                updateBalance();
                setupWalletListeners(provider);

            } catch (error) {
                console.error("Error setting up wallet connection:", error);
                showStatus('‚ùå Failed to initialize wallet session.', 'error');
                disconnectWallet();
            }
        };

        const connectWallet = async () => {
            try {
                showStatus('‚è≥ Connecting wallet...', 'loading');

                if (!window.ethereum) {
                    return showStatus(isMobile() ? '‚ùå No wallet found. Try WalletConnect.' : '‚ùå Please install a Web3 wallet extension.', 'error');
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await onWalletConnected(window.ethereum);
                
            } catch (error) {
                console.error('Browser wallet connection failed:', error);
                let msg = '‚ùå Connection failed. ';
                if (error.code === 4001) msg += 'Please approve the connection request.';
                else if (error.code === -32002) msg += 'Please check wallet for pending requests.';
                else msg += 'Please try again.';
                showStatus(msg, 'error');
            }
        };

        const connectWithWalletConnect = async () => {
            if (CONFIG.WALLETCONNECT_PROJECT_ID === 'YOUR_WALLETCONNECT_PROJECT_ID') {
                return showStatus('üîß Please configure WalletConnect Project ID in the script.', 'error');
            }
            try {
                wcProvider = new WalletConnectProvider.default({
                    infuraId: null, // Not needed if you provide RPC URLs
                    rpc: {
                        1: "https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161",
                        10: "https://mainnet.optimism.io",
                        56: "https://bsc-dataseed.binance.org/",
                        130: "https://rpc.unichain.world/",
                        137: "https://polygon-rpc.com/",
                        43114: "https://api.avax.network/ext/bc/C/rpc",
                        59144: "https://rpc.linea.build",
                        42161: "https://arb1.arbitrum.io/rpc",
                        8453: "https://mainnet.base.org",
                    },
                    qrcode: false // We handle QR code generation manually
                });

                wcProvider.on("uri", (uri) => {
                    const qrCode = new QRCodeStyling({
                        width: 280,
                        height: 280,
                        data: uri,
                        image: "https://li.fi/logo-circle.png",
                        dotsOptions: { color: "#4f46e5", type: "rounded" },
                        backgroundOptions: { color: "#ffffff" },
                        imageOptions: { crossOrigin: "anonymous", margin: 4 }
                    });
                    const qrContainer = document.getElementById("qr-code-container");
                    qrContainer.innerHTML = '';
                    qrCode.append(qrContainer);
                    document.getElementById('mobile-connect-link').href = `https://metamask.app.link/wc?uri=${encodeURIComponent(uri)}`;
                    showWCModal();
                });
                
                wcProvider.on("disconnect", () => disconnectWallet());

                await wcProvider.enable();
                await onWalletConnected(wcProvider);

            } catch (error) {
                console.error("WalletConnect failed:", error);
                showStatus('‚ùå WalletConnect connection cancelled or failed.', 'error');
                hideWCModal();
            }
        };


        const disconnectWallet = async () => {
            if (wcProvider?.connected) {
                await wcProvider.disconnect();
            }
            currentUser = currentProvider = currentSigner = currentQuote = wcProvider = null;
            hideStatus();
            showScreen('auth-screen');
        };
        
        const handleAccountsChanged = (accounts) => accounts.length === 0 ? disconnectWallet() : window.location.reload();
        const handleChainChanged = () => window.location.reload();

        const setupWalletListeners = (provider) => {
             provider.on('accountsChanged', handleAccountsChanged);
             provider.on('chainChanged', handleChainChanged);
        };


        // --- DATA & STATE MANAGEMENT --- //

        const updateBalance = async () => {
            if (!currentSigner) return;
            const fromChain = document.getElementById('from-chain').value;
            const fromTokenSymbol = document.getElementById('from-token').value;
            const balanceEl = document.getElementById('from-balance');
            balanceEl.textContent = 'Balance: ...';

            const token = allTokens[fromChain]?.find(t => t.symbol === fromTokenSymbol);
            if (!token) { 
                balanceEl.textContent = 'Balance: -'; 
                currentBalance = '0';
                return; 
            }

            try {
                const balanceBN = token.address === ethers.constants.AddressZero
                    ? await currentProvider.getBalance(currentUser.wallet.address)
                    : await (new ethers.Contract(token.address, ['function balanceOf(address) view returns (uint256)'], currentProvider)).balanceOf(currentUser.wallet.address);

                currentBalance = ethers.utils.formatUnits(balanceBN, token.decimals);
                balanceEl.textContent = `Balance: ${parseFloat(currentBalance).toFixed(4)}`;
            } catch (error) {
                console.error("Failed to get balance", error);
                balanceEl.textContent = `Balance: -`;
                currentBalance = '0';
            }
        };

        const populateDropdowns = async () => {
            try {
                showStatus('‚è≥ Loading chains and tokens...', 'loading');
                const [chainsResponse, tokensResponse] = await Promise.all([
                    fetch(`${CONFIG.LIFI_API_URL}/chains`),
                    fetch(`${CONFIG.LIFI_API_URL}/tokens`)
                ]);

                if (!chainsResponse.ok || !tokensResponse.ok) throw new Error('Failed to fetch data from LI.FI API');

                const { chains: availableChains } = await chainsResponse.json();
                const { tokens } = await tokensResponse.json();
                allTokens = tokens;
                
                const chainSet = new Set(CONFIG.LIFI_CHAINS);
                allChains = CONFIG.LIFI_CHAINS.length > 0 ? availableChains.filter(c => chainSet.has(c.id)) : availableChains;

                const fromChainEl = document.getElementById('from-chain');
                const toChainEl = document.getElementById('to-chain');
                [fromChainEl, toChainEl].forEach(el => el.innerHTML = '');
                allChains.forEach(chain => {
                    [fromChainEl, toChainEl].forEach(el => el.add(new Option(chain.name, chain.id)));
                });
                
                fromChainEl.value = allChains[0]?.id || 1;
                toChainEl.value = allChains.find(c => c.id === 137) ? 137 : (allChains[1]?.id || 1);

                populateTokenList(fromChainEl.value, 'from-token');
                populateTokenList(toChainEl.value, 'to-token');
                hideStatus();
            } catch(error) { 
                console.error("Failed to populate dropdowns", error);
                showStatus(`‚ùå Failed to load data: ${error.message}`, 'error');
            }
        };
        
        const populateTokenList = (chainId, elementId) => {
            const dropdown = document.getElementById(elementId);
            dropdown.innerHTML = '';
            let chainTokens = allTokens[chainId] || [];
            
            const tokenSet = new Set(CONFIG.LIFI_TOKENS);
            if (CONFIG.LIFI_TOKENS.length > 0) {
                 chainTokens = chainTokens.filter(token => tokenSet.has(token.symbol));
            }
            // Limit to 100 most popular tokens for performance
            chainTokens.slice(0, 100).forEach(token => dropdown.add(new Option(token.symbol, token.symbol)));
        };

        // --- CORE SWAP LOGIC --- //

        const getQuote = async () => {
            const fromAmount = document.getElementById('from-amount').value;
            const fromChain = document.getElementById('from-chain').value;
            const toChain = document.getElementById('to-chain').value;
            const fromTokenSymbol = document.getElementById('from-token').value;
            const toTokenSymbol = document.getElementById('to-token').value;

            if (!fromAmount || parseFloat(fromAmount) <= 0) return;

            const fromToken = allTokens[fromChain]?.find(t => t.symbol === fromTokenSymbol);
            const toToken = allTokens[toChain]?.find(t => t.symbol === toTokenSymbol);
            if (!fromToken || !toToken) return showStatus('‚ùå Invalid token selection', 'error');

            try {
                showStatus('‚è≥ Getting quote...', 'loading');
                document.getElementById('swap-btn').disabled = true;

                const fromAmountWei = ethers.utils.parseUnits(fromAmount, fromToken.decimals).toString();
                const params = new URLSearchParams({
                    fromChain, toChain, fromToken: fromToken.address, toToken: toToken.address,
                    fromAmount: fromAmountWei, fromAddress: currentUser.wallet.address,
                    integrator: CONFIG.LIFI_INTEGRATOR,
                    fee: 0.01 // Example: 1% fee on destination
                });

                const response = await fetch(`${CONFIG.LIFI_API_URL}/quote?${params}`);
                if (!response.ok) throw new Error(await response.text());
                currentQuote = await response.json();

                // Update UI with quote details
                const estAmount = ethers.utils.formatUnits(currentQuote.estimate.toAmount, toToken.decimals);
                document.getElementById('to-amount').value = parseFloat(estAmount).toFixed(6);
                const rate = (parseFloat(estAmount) / parseFloat(fromAmount)).toFixed(6);
                document.getElementById('exchange-rate').textContent = `1 ${fromTokenSymbol} ‚âà ${rate} ${toTokenSymbol}`;

                const gasCost = currentQuote.estimate.gasCosts?.[0];
                const gasInNative = gasCost ? ethers.utils.formatUnits(gasCost.amount, gasCost.token.decimals) : '0';
                document.getElementById('gas-fee').textContent = `${parseFloat(gasInNative).toFixed(5)} ${gasCost.token.symbol}`;

                const totalFee = currentQuote.estimate.feeCosts.reduce((sum, fee) => sum + (parseFloat(ethers.utils.formatUnits(fee.amount, fee.token.decimals)) * fee.token.priceUSD), 0);
                document.getElementById('total-fee').textContent = `$${totalFee.toFixed(2)}`;

                document.getElementById('route-info').classList.remove('hidden');
                document.getElementById('swap-btn').textContent = 'Execute Swap';
                document.getElementById('swap-btn').disabled = false;
                hideStatus();
            } catch (error) {
                console.error('Quote error:', error);
                showStatus(`‚ùå Quote failed: ${error.message || 'Check console'}`, 'error');
                document.getElementById('swap-btn').textContent = 'Get Quote';
                document.getElementById('swap-btn').disabled = false;
            }
        };

        const executeSwap = async () => {
            if (!currentQuote) return;

            try {
                showStatus('‚è≥ Executing swap... Please confirm in your wallet.', 'loading');
                document.getElementById('swap-btn').disabled = true;
                
                const tx = await currentSigner.sendTransaction(currentQuote.transactionRequest);
                const explorerLink = currentQuote.toolDetails?.explorer?.txLink(tx.hash) || '#';
                showStatus(`‚è≥ Tx sent... waiting for confirmation. <a href="${explorerLink}" target="_blank" class="underline">View Explorer</a>`, 'loading');
                
                const receipt = await tx.wait();
                showStatus(`‚úÖ Swap complete! <a href="${explorerLink}" target="_blank" class="underline">View Receipt</a>`, 'success');
                
                // Reset form state after successful swap
                ['from-amount', 'to-amount'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('route-info').classList.add('hidden');
                currentQuote = null;
                updateSwapButtonState();
                updateBalance();
            } catch (error) {
                console.error('Swap error:', error);
                showStatus(`‚ùå Swap failed: ${error.reason || error.message}`, 'error');
                document.getElementById('swap-btn').disabled = false;
            }
        };

        const updateSwapButtonState = () => {
            const amount = document.getElementById('from-amount').value;
            const btn = document.getElementById('swap-btn');
            if (!amount || parseFloat(amount) <= 0) {
                btn.textContent = 'Enter Amount';
                btn.disabled = true;
            } else if (currentQuote) {
                btn.textContent = 'Execute Swap';
                btn.disabled = false;
            } else {
                btn.textContent = 'Get Quote';
                btn.disabled = false;
            }
        };

        // --- APP INITIALIZATION --- //

        function initializeApp() {
            console.log('üöÄ Initializing TimaxPaySwap with config:', CONFIG);

            // Wallet buttons
            document.getElementById('metamask-option').addEventListener('click', connectWallet);
            document.getElementById('trust-wallet-option').addEventListener('click', connectWallet);
            document.getElementById('walletconnect-option').addEventListener('click', connectWithWalletConnect);
            
            // Modal close button
            document.getElementById('close-modal-btn').addEventListener('click', hideWCModal);

            // Widget controls
            document.getElementById('disconnect-wallet-btn').addEventListener('click', disconnectWallet);
            document.getElementById('swap-btn').addEventListener('click', () => currentQuote ? executeSwap() : getQuote());
            
            document.getElementById('from-amount').addEventListener('input', () => {
                currentQuote = null;
                document.getElementById('route-info').classList.add('hidden');
                document.getElementById('to-amount').value = '';
                updateSwapButtonState();
            });
            
            document.getElementById('max-btn').addEventListener('click', () => { 
                document.getElementById('from-amount').value = currentBalance;
                document.getElementById('from-amount').dispatchEvent(new Event('input'));
            });

            document.getElementById('swap-direction').addEventListener('click', () => {
                const fromChain = document.getElementById('from-chain');
                const toChain = document.getElementById('to-chain');
                const fromToken = document.getElementById('from-token');
                const toToken = document.getElementById('to-token');

                [fromChain.value, toChain.value] = [toChain.value, fromChain.value];
                const [oldFromToken, oldToToken] = [fromToken.value, toToken.value];

                // Trigger events to repopulate lists, which also updates balance
                fromChain.dispatchEvent(new Event('change'));
                toChain.dispatchEvent(new Event('change'));
                
                // Set swapped token values
                fromToken.value = oldToToken;
                toToken.value = oldFromToken;

                // Reset amounts and quote
                ['from-amount', 'to-amount'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('route-info').classList.add('hidden');
                currentQuote = null;
                updateSwapButtonState();
            });

            // Set up chain/token dropdown change listeners
            ['from-chain', 'to-chain', 'from-token', 'to-token'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    if (id === 'from-chain') populateTokenList(document.getElementById('from-chain').value, 'from-token');
                    if (id === 'to-chain') populateTokenList(document.getElementById('to-chain').value, 'to-token');
                    if(id.startsWith('from-')) updateBalance();
                    // Reset quote if any parameter changes
                    currentQuote = null; 
                    document.getElementById('route-info').classList.add('hidden');
                    updateSwapButtonState();
                });
            });
            
            // Check for persistent connection
            if (window.ethereum?.selectedAddress) {
                connectWallet();
            } else {
                showScreen('auth-screen');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
        // --- SCRIPT END --- //
    </script>
</body>
</html>

